<!doctype html>      
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride 🌈｜Reservation Payment｜10/24 週五晚餐名單</title>
<style>
/* …（原樣，未更動）… */
:root{
  /* S2 風格色盤 */
  --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
  --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;
  background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);
  color:var(--fg);
}
a{color:inherit;text-decoration:none}
.wrap{max-width:980px;margin:28px auto 64px;padding:0 14px}

/* …（以下 CSS 全部保留）… */

/* ================== 🔳 QR 掃描懸浮視窗（新增） ================== */
#scanBackdrop{display:none; align-items:center; justify-content:center;}
.scan-modal{
  width:min(760px,94vw); background:#0f1117; border-radius:16px; border:1px solid #2b3244;
  box-shadow:0 20px 60px rgba(0,0,0,.55); position:relative; padding:0; overflow:hidden;
}
.scan-head{
  position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:10px;
  padding:10px 12px; background:#0f1117; border-bottom:1px solid #2b3244;
}
.scan-title{font-size:16px; font-weight:800}
.scan-close{
  margin-left:auto; width:28px; height:28px; background:transparent; border:none; color:#60a5fa;
  text-shadow:0 0 8px rgba(96,165,250,.8),0 0 14px rgba(96,165,250,.5); cursor:pointer; font-size:20px; line-height:1;
}
.scan-body{ position:relative; aspect-ratio:3/4; background:#000; }
#scanVideo{ width:100%; height:100%; object-fit:cover; display:block; }

/* 對準框與十字線 */
.scan-overlay{
  position:absolute; inset:0; pointer-events:none;
  display:block;
}
.scan-frame{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(70vmin, 78%); aspect-ratio:1/1; /* 正方形框 */
  box-shadow:0 0 0 200vmax rgba(0,0,0,.35); /* 外暗角 */
  border-radius:18px;
}
.scan-corners{
  position:absolute; inset:0;
}
.scan-corners::before,
.scan-corners::after{
  content:""; position:absolute; inset:0; border-radius:18px;
  border:2px solid transparent;
  /* 用線性漸層只畫四角 */
  --g: #a7f3d0;
  background:
    linear-gradient(90deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) top/100% 2px,
    linear-gradient(90deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) bottom/100% 2px,
    linear-gradient(0deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) left/2px 100%,
    linear-gradient(0deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) right/2px 100%;
  background-repeat:no-repeat;
  filter:drop-shadow(0 0 8px rgba(167,243,208,.45));
}
.scan-cross{
  position:absolute; inset:0;
}
.scan-cross::before, .scan-cross::after{
  content:""; position:absolute; left:50%; top:50%;
  background:#e5e7eb80; filter:drop-shadow(0 0 6px rgba(255,255,255,.35));
}
.scan-cross::before{ /* 垂直線 */
  width:2px; height:52%; transform:translate(-50%,-50%);
}
.scan-cross::after{  /* 水平線 */
  height:2px; width:52%; transform:translate(-50%,-50%);
}
.scan-hint{
  position:absolute; left:0; right:0; bottom:10px; text-align:center; font-size:12px; color:#cbd5e1;
  text-shadow:0 1px 2px rgba(0,0,0,.6);
}
.scan-foot{
  padding:8px 12px; border-top:1px solid #2b3244; display:flex; align-items:center; justify-content:flex-end; gap:8px; background:#0f1117;
}
.scan-btn{ padding:8px 10px; border-radius:10px; border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; font-weight:800; cursor:pointer; }
.scan-btn.primary{ background:var(--btn-grad); color:#0b0c10; border:0; }

/* ============================================================ */
</style>
</head>
<body>
<div class="wrap">
  <!-- …（原本 HTML 結構完全保留，未更動）… -->
  <!-- 標題、統計、控制面板、各種 Modal 等 -->
</div>

<!-- 收合時顯示的六色彩虹開關 -->
<button id="btnOvShow" class="ov-toggle" title="顯示總覽 / Show Overview">
  <span class="dot" aria-hidden="true"></span><span>總覽 Overview</span>
</button>

<!-- 付款彈窗、清單 Modal、NOTE Modal …（原樣保留） -->

<!-- 🔳 掃描 QR 懸浮視窗（原樣保留） -->
<div id="scanBackdrop" class="backdrop">
  <div class="scan-modal">
    <div class="scan-head">
      <div class="scan-title">掃描 QR / Scan QR</div>
      <button id="scanClose" class="scan-close" aria-label="Close">×</button>
    </div>
    <div class="scan-body">
      <video id="scanVideo" playsinline muted></video>
      <div class="scan-overlay">
        <div class="scan-frame">
          <div class="scan-corners"></div>
          <div class="scan-cross"></div>
          <div class="scan-hint">將 QR 對準方框與十字線中央</div>
        </div>
      </div>
    </div>
    <div class="scan-foot">
      <button id="scanPickImage" class="scan-btn">從圖片辨識</button>
      <button id="scanRetry" class="scan-btn">重新連線</button>
      <button id="scanDone" class="scan-btn primary">完成</button>
    </div>
  </div>
</div>

<!-- 隱藏的檔案 input 供「QR 圖片備援」 -->
<input id="qrFile" type="file" accept="image/*" capture="environment" style="display:none" />

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ===== (1) 設定：換成你的 GAS URL ===== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwtoGYXhk6qd0XuTOUvB6YZNNzdjXoGQEl7298-Pbtc-G-qNuoLM2kTknZZOQO9qZ_Y1A/exec';
const PAY_PASSWORD = '05140714';
/* ✅ 是否啟用送出時密碼驗證（暫時關閉就設 false；要再開啟改 true） */
const ENABLE_PAY_PASSWORD = false;
/* ✅ NOTE 密碼改為獨立常數（預設 0327） */
const NOTE_PASSWORD = '0327';

/* ===== (2) 狀態 ===== */
const state = {
  rows: [],          // 雲端 roster
  indexByItem: new Map(),
  selected: null,    // 付款彈窗選中的人
  chosenPay: null,   // 'paid' / 'unpaid'
  ovHidden: false,   // 概覽是否收合
  /* NOTE 功能（預設欄寬） */
  nameW: 60,
  igW: 60,
  /* 清單（Paid/Unpaid）欄寬（滑桿三項） */
  listNameW: 120,
  listIgW: 120,
  listLeaderW: 90,
  noteAuthed: false
};
const hiddenLeaders = new Set();
const RAINBOW = ['#EF4444','#F59E0B','#FACC15','#22C55E','#3B82F6','#8B5CF6'];

/* ===== (3) 小工具 ===== */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||'').toString().trim().toLowerCase();
const showToast = (msg)=>{
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1600);
};
const headMsg = (html, spinning=false)=>{
  $('head').innerHTML = '';
  const span = document.createElement('span');
  span.id='headMsg'; span.innerHTML = html;
  $('head').appendChild(span);
  if(spinning){
    const sp=document.createElement('span'); sp.className='spinner';
    $('head').appendChild(sp);
  }
};
/* 小圖示（勾/叉） */
const SVG_CHECK = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#22c55e" stroke-width="2.6"/><path d="M7 12.5l3 3 6-6" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';
const SVG_CROSS = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#ef4444" stroke-width="2.6"/><path d="M8 8l8 8M16 8l-8 8" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';

/* ===== (4) 讀取雲端（進頁就載 & 渲染總覽） ===== */
async function fetchRoster(){
  try{
    headMsg('資料載入中… / Loading roster…', true);
    const res = await fetch(WEB_APP_URL + '?mode=roster', {cache:'no-store'});
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.rows || []);
    rows.forEach(r=>{
      if(!('pay_status' in r) || !r.pay_status) r.pay_status = 'unpaid';
      // 確保 NOTE 欄位存在（不破壞既有）
      if(!('confirm' in r)) r.confirm = false;
      if(!('pay_method' in r)) r.pay_method = '';
      if(!('note' in r)) r.note = '';
    });
    state.rows = rows;
    state.indexByItem.clear();
    for(const r of rows){ if(r.item) state.indexByItem.set(String(r.item), r); }

    rebuildDatalists();
    renderStats();
    headMsg('', false);
    renderOverview();
  }catch(err){
    console.error(err);
    headMsg('名單載入失敗（可能不是 JSON 或 CORS）/ Failed to load roster', false);
  }
}
function rebuildDatalists(){
  const dlN = $('nameList'); const dlI = $('igList');
  dlN.innerHTML=''; dlI.innerHTML='';
  const names = [...new Set(state.rows.map(r=>r.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const igs = [...new Set(state.rows.map(r=>r.ig).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  names.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlN.appendChild(o); });
  igs.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlI.appendChild(o); });
}

/* ===== (5) 統計 ===== */
function renderStats(){
  const total = state.rows.length;
  const paid = state.rows.filter(r=> norm(r.pay_status)==='paid').length;
  const unpaid = total - paid;
  $('sTotal').textContent = total;
  $('sPaid').textContent = paid;
  $('sUnpaid').textContent= unpaid;
}

/* ===== (6) 搜尋（手動）→ 付款彈窗 ===== */
$('btnSearch').addEventListener('click', manualSearch);
$('nameInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });
$('igInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });

function manualSearch(){
  if(!state.rows.length){ showToast('名單未就緒 / Roster not ready'); return; }
  const qn = norm($('nameInput').value);
  const qi = norm($('igInput').value);

  if(qi){
    const row = state.rows.find(r=> norm(r.ig)===qi);
    if(row) { openPayModal(row); return; }
  }
  if(qn){
    const row = state.rows.find(r=> norm(r.name)===qn);
    if(row) { openPayModal(row); return; }
  }
  const cand = state.rows.filter(r => (qi && norm(r.ig||'').includes(qi)) || (qn && norm(r.name||'').includes(qn)) );
  if(cand.length===1){ openPayModal(cand[0]); return; }
  renderOnlyMatches(cand);
}

function renderOnlyMatches(rows){
  const grid = $('grid'); grid.innerHTML = '';
  if(!rows || !rows.length){ headMsg('查無資料 / No results', false); return; }
  headMsg(`符合 ${rows.length} 筆 / matched records`, false);
  rows.slice().sort((a,b)=> (a.country||'').localeCompare(b.country||'') || (a.name||'').localeCompare(b.name||''))
    .forEach(r=> grid.appendChild(renderPerson(r)));
}

function renderPerson(r){
  const card = document.createElement('div');
  card.className='person';
  card.dataset.item = String(r.item||''); // ★ 加入 data-item 供補丁更新
  card.addEventListener('click', ()=> openPayModal(r)); // 點卡片開彈窗

  // 第一行
  const L1 = document.createElement('div'); L1.className='line';
  const left1 = document.createElement('div'); left1.className='left namebar';
  const flag = document.createElement('div'); flag.className='flag'; flag.textContent = r.flag || '—';
  const ctry = document.createElement('span'); ctry.className='country'; ctry.textContent = r.country || '—';
  const name = document.createElement('span'); name.className='personN goldtext'; name.textContent = r.name || '—';
  const ig = document.createElement('span'); ig.className='ig goldtext'; ig.textContent = r.ig || '—';
  left1.append(flag, ctry, name, ig);
  L1.append(left1);

  // 第二行：pay_status + link
  const L2 = document.createElement('div'); L2.className='line';
  const left2 = document.createElement('div'); left2.className='left paybox iconsonly';
  left2.append(buildPay(r.pay_status, true));
  const right2 = document.createElement('div'); right2.className='right';
  if(r.link){
    const a = document.createElement('a'); a.href = r.link; a.target='_blank'; a.rel='noopener noreferrer'; a.className='link-btn';
    const img = document.createElement('img'); img.src='pngsucai_1605688_ec16ce.png'; img.alt='Open link';
    a.appendChild(img); right2.appendChild(a);
  }
  L2.append(left2, right2);

  card.append(L1,L2);
  return card;
}

function buildPay(status, iconsOnly=false){
  const s = norm(status)==='paid' ? 'paid' : 'unpaid';
  const box = document.createElement('div'); box.className='pay';
  const badge = document.createElement('div'); badge.className='badge '+s;
  badge.innerHTML = s==='paid'
    ? '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M7 12.5l3 3 6-6"/></svg>'
    : '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M8 8l8 8M16 8l-8 8"/></svg>';
  const circle = badge.querySelector('circle');
  if(circle){
    if(s==='paid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--ok')||'#22c55e');
    if(s==='unpaid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--bad')||'#ef4444');
  }
  box.append(badge);
  if(!iconsOnly){
    const lab = document.createElement('div'); lab.className='label';
    lab.innerHTML = s==='paid' ? '<span class="zh">已繳費</span><span class="en">Paid</span>' : '<span class="zh">未繳費</span><span class="en">Unpaid</span>';
    box.append(lab);
  }
  return box;
}

/* ===== (7) 付款彈窗 ===== */
const payBackdrop = $('payBackdrop');
const paySubmit = $('paySubmit');
$('payClose').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); });
$('payCloseX').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); }); /* 右上角叉叉 */
$('optPaid').addEventListener('click', ()=> setOptActive('paid'));
$('optUnpaid').addEventListener('click', ()=> setOptActive('unpaid'));

function setOptActive(val){
  state.chosenPay = val;
  document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
  if(val==='paid') $('optPaid').classList.add('active');
  if(val==='unpaid') $('optUnpaid').classList.add('active');
}

function openPayModal(person){
  state.selected = person;
  setOptActive(null);
  const gold = (s)=> `<b class="goldtext">${escapeHtml(s||'—')}</b>`;
  const html = `
    <div>國旗 / Flag：<b>${escapeHtml(person.flag||'—')}</b></div>
    <div>姓名 / Name：${gold(person.name)}</div>
    <div>IG：${gold(person.ig)}</div>
    <div>目前狀態 / Current：<b>${norm(person.pay_status)==='paid'?'已繳費 / Paid':'未繳費 / Unpaid'}</b></div>
  `;
  $('payInfo').innerHTML = html;
  payBackdrop.style.display='flex';
}
function escapeHtml(s){
  return (s||'').toString().replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

/* ===== 送出付款更新 ===== */
paySubmit.addEventListener('click', async ()=>{
  if(!state.selected){ payBackdrop.style.display='none'; return; }
  if(!state.chosenPay){ showToast('請選擇「已付款或未付款」'); return; }
  if (ENABLE_PAY_PASSWORD) {
    const p = prompt('請輸入付款更新密碼 / Enter password');
    if(p === null) return;
    if(p !== PAY_PASSWORD){ showToast('密碼錯誤 / Wrong password'); return; }
  }
  const prevHtml = paySubmit.innerHTML;
  paySubmit.disabled = true;
  paySubmit.innerHTML = '送出中… <span class="spinner" aria-hidden="true"></span>';
  try{
    await updatePay(state.chosenPay);
  }catch(e){
    console.error(e);
    showToast('更新失敗 / Update failed');
  }finally{
    paySubmit.disabled = false;
    paySubmit.innerHTML = prevHtml;
    state.chosenPay = null; setOptActive(null);
    payBackdrop.style.display = 'none';
  }
});

/* ★★★★★ 只補丁更新，不重繪整頁（大幅降低延遲） ★★★★★ */
function patchPayDom(item, val){
  const safe = String(item||'');
  document.querySelectorAll(`.person[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    const iconsOnly = el.classList.contains('iconsonly');
    el.innerHTML = ''; el.appendChild(buildPay(val, iconsOnly));
  });
  document.querySelectorAll(`.member-line[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    el.innerHTML = ''; el.appendChild(buildPay(val, /*iconsOnly*/ false));
  });
}

async function updatePay(val){
  const person = state.selected;
  try{
    const payload = { action:'updatePayStatus', item:String(person.item||''), pay_status:val };
    const ok = await postMaybeOk(payload);
    if(!ok) throw new Error('SERVER_NOK');
    person.pay_status = val;
    const local = state.indexByItem.get(String(person.item||'')); if(local) local.pay_status = val;
    renderStats(); patchPayDom(person.item, val);
    showToast('已更新付款狀態 / Payment updated');
  }catch(e){
    console.error(e); showToast('更新失敗 / Update failed');
  }
}

/* 能容忍多種後端 Content-Type / CORS 策略 */
async function postMaybeOk(bodyObj){
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  const form = new URLSearchParams(); Object.entries(bodyObj).forEach(([k,v])=> form.append(k,String(v)));
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString(), mode:'no-cors', cache:'no-store' })) return true;
  return false;
}
async function tryFetch(url, init){
  try{
    const res = await fetch(url, init);
    if(res.type==='opaque') return true;
    if(res.ok) return true;
    try{ const j = await res.json(); return !!(j && (j.ok || Array.isArray(j))); }catch(_){}
    return false;
  }catch(_){ return false; }
}

/* ===== (8) 概覽 ===== */
/* …（原樣保留）… */

/* ===== (9) 掃描 QR（懸浮視窗） ===== */
$('btnScan').addEventListener('click', startScan);

const scan = {
  stream: null,
  detector: null,
  raf: 0,
  running: false,
  useJsQR: false
};

/* -------------------- jsQR 後備：lazy-load 與抽幀解析 -------------------- */
let _offscreenCanvas = null, _offCtx = null, _lastJsQR = 0;
function getOffCanvas(w, h){
  if(!_offscreenCanvas){
    _offscreenCanvas = document.createElement('canvas');
    _offCtx = _offscreenCanvas.getContext('2d', { willReadFrequently: true });
  }
  _offscreenCanvas.width = w;
  _offscreenCanvas.height = h;
  return _offCtx;
}
function now(){ return performance && performance.now ? performance.now() : Date.now(); }

async function ensureJsQR(){
  if (window.jsQR) return true;
  return await new Promise((resolve)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
    s.async = true;
    s.onload = ()=> resolve(true);
    s.onerror = ()=> resolve(false);
    document.head.appendChild(s);
  });
}

async function loopDetectJsQR(){
  const video = $('scanVideo');
  const tick = ()=>{
    if(!scan.running || !scan.useJsQR) return;
    const t = now();
    // 以 120~150ms 解析節流，避免高 CPU
    if (t - _lastJsQR < 140) { scan.raf = requestAnimationFrame(tick); return; }
    _lastJsQR = t;

    try{
      const vw = video.videoWidth || 0, vh = video.videoHeight || 0;
      if(vw && vh){
        // 縮圖到最長邊 640（提速），維持比例
        const scale = Math.min(1, 640 / Math.max(vw, vh));
        const w = Math.max(160, Math.round(vw * scale));
        const h = Math.max(160, Math.round(vh * scale));
        const ctx = getOffCanvas(w, h);
        ctx.drawImage(video, 0, 0, w, h);
        const img = ctx.getImageData(0, 0, w, h);
        if (window.jsQR){
          const res = window.jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
          if (res && res.data){
            const raw = (res.data||'').trim();
            closeScanModal().then(()=> handleScanItem(raw));
            return;
          }
        }
      }
    }catch(err){ console.warn('jsQR detect err', err); }
    scan.raf = requestAnimationFrame(tick);
  };
  scan.raf = requestAnimationFrame(tick);
}
/* -------------------- jsQR 後備結束 -------------------- */

async function startScan(){
  openScanModal();

  // ① 先請求相機（確保 iPhone 會跳權限）
  try{
    scan.stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'environment' },
      audio:false
    });
  }catch(e){
    console.warn('getUserMedia 失敗', e);
    if (e && (e.name === 'NotAllowedError' || e.name === 'SecurityError')) {
      showToast('無法使用相機，請在 Safari 的網站設定允許相機');
    } else if (e && e.name === 'NotFoundError') {
      showToast('未偵測到相機裝置');
    } else {
      showToast('相機啟用失敗，改用圖片辨識');
    }
    pickImageForScan(); // 退回圖片辨識
    return;
  }

  // 顯示相機畫面
  const video = $('scanVideo');
  video.srcObject = scan.stream;
  await video.play();

  // ② 優先使用 BarcodeDetector；若不支援 → 後備 jsQR
  if (!('BarcodeDetector' in window)) {
    scan.useJsQR = await ensureJsQR();
    if (!scan.useJsQR){
      showToast('此裝置不支援即時解析；請改用圖片辨識或手動查找');
      return;
    }
    showToast('已啟用 jsQR 後備解析');
    scan.running = true;
    loopDetectJsQR();
    return;
  }
  try{
    scan.detector = new window.BarcodeDetector({ formats:['qr_code'] });
  }catch(e){
    console.warn('BarcodeDetector 建立失敗', e);
    scan.useJsQR = await ensureJsQR();
    if (!scan.useJsQR){
      showToast('裝置不支援即時解析；請改用圖片辨識或手動查找');
      return;
    }
    showToast('已啟用 jsQR 後備解析');
    scan.running = true;
    loopDetectJsQR();
    return;
  }

  // ③ 進入即時掃描（原生條碼）
  scan.useJsQR = false;
  scan.running = true;
  loopDetectNative();
}

async function loopDetectNative(){
  const video = $('scanVideo');
  const tick = async ()=>{
    if(!scan.running || !scan.detector) return;
    try{
      if(video.readyState >= 2){
        const bitmap = await createImageBitmap(video);
        const codes = await scan.detector.detect(bitmap);
        bitmap.close();
        if(codes && codes.length){
          const raw = (codes[0].rawValue||'').trim();
          await closeScanModal();
          handleScanItem(raw);
          return;
        }
      }
    }catch(err){
      console.warn('native detect err', err);
      // 一旦原生偵測報錯，立即切換到 jsQR 後備（避免卡住）
      scan.useJsQR = await ensureJsQR();
      if (scan.useJsQR){
        showToast('已切換到 jsQR 後備解析');
        loopDetectJsQR();
        return;
      }
    }
    scan.raf = requestAnimationFrame(tick);
  };
  scan.raf = requestAnimationFrame(tick);
}

async function stopScan(){
  scan.running = false;
  if(scan.raf){ cancelAnimationFrame(scan.raf); scan.raf = 0; }
  try{
    if(scan.stream){ scan.stream.getTracks().forEach(t=>t.stop()); }
  }catch(_){}
  scan.stream = null;
}

function openScanModal(){
  $('scanBackdrop').style.display='flex';
}
async function closeScanModal(){
  await stopScan();
  $('scanBackdrop').style.display='none';
}

/* 懸浮視窗按鈕 */
$('scanClose').addEventListener('click', closeScanModal);
$('scanDone').addEventListener('click', closeScanModal);
$('scanRetry').addEventListener('click', async ()=>{
  await stopScan();
  startScan();
});
$('scanPickImage').addEventListener('click', pickImageForScan);

function pickImageForScan(){
  const input = $('qrFile');
  input.onchange = async (e)=>{
    const f = (e.target.files||[])[0];
    if(!f){ showToast('未選取圖片'); return; }
    try{
      // 先嘗試 BarcodeDetector
      if('BarcodeDetector' in window){
        try{
          const detector = new window.BarcodeDetector({ formats:['qr_code'] });
          const bmp = await createImageBitmap(f);
          const codes = await detector.detect(bmp);
          bmp.close();
          if(codes && codes.length){
            const raw = (codes[0].rawValue||'').trim();
            await closeScanModal();
            handleScanItem(raw);
            return;
          }
        }catch(e){ /* 繼續走 jsQR 後備 */ }
      }
      // 後備：jsQR
      const ok = await ensureJsQR();
      if (!ok){ throw new Error('jsQR-load-failed'); }

      const imgBitmap = await createImageBitmap(f);
      const w = Math.min(1280, imgBitmap.width);
      const h = Math.round(imgBitmap.height * (w / imgBitmap.width));
      const ctx = getOffCanvas(w, h);
      ctx.drawImage(imgBitmap, 0, 0, w, h);
      imgBitmap.close();

      const img = ctx.getImageData(0, 0, w, h);
      const res = window.jsQR && window.jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
      if(res && res.data){
        const raw = (res.data||'').trim();
        await closeScanModal();
        handleScanItem(raw);
      }else{
        showToast('解析失敗，請換張清楚的 QR 圖片');
      }
    }catch(err){
      console.warn(err); showToast('裝置不支援 QR 解析；請改用手動查找');
    } finally { input.value=''; }
  };
  input.click();
}

function handleScanItem(itemStr){
  if(!itemStr){ showToast('QR 無內容 / Empty QR'); return; }
  const row = state.indexByItem.get(String(itemStr));
  if(!row){ showToast('查無此 ITEM · 請確認 / Item not found'); return; }
  openPayModal(row);
}

/* ===== (10) 重新整理 & 故障診斷 ===== */
$('btnRefresh').addEventListener('click', ()=> fetchRoster()); // 診斷按鈕暫不運作（已於 HTML 隱藏並 disabled）

/* ===== (11) 已繳費/未繳費清單 ===== */
/* …（原樣保留）… */

/* ===== (12) NOTE 功能 ===== */
/* …（原樣保留）… */

/* ===== 啟動 & 錯誤攔截 ===== */
window.addEventListener('error', (e)=>{ try{ console.error('[GlobalError]', e.message, e.filename, e.lineno, e.colno, e.error); }catch(_){}
  try{ showToast('發生錯誤：' + (e.message || 'Script error')); }catch(_){} });
window.addEventListener('unhandledrejection', (e)=>{ try{ console.error('[UnhandledRejection]', e.reason); }catch(_){}
  try{ showToast('發生錯誤（Promise）：' + (e.reason && e.reason.message ? e.reason.message : '')); }catch(_){}

});

/* ===== List/Note 背景點擊收合 ===== */
listBackdrop.addEventListener('click', (e)=>{ if(e.target===listBackdrop) listBackdrop.style.display='none'; });

fetchRoster();
</script>
</body>
</html>
