<!doctype html>      
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride ğŸŒˆï½œReservation Paymentï½œ10/24 é€±äº”æ™šé¤åå–®</title>
<style>
/* â€¦ï¼ˆåŸæ¨£ï¼Œæœªæ›´å‹•ï¼‰â€¦ */
:root{
  /* S2 é¢¨æ ¼è‰²ç›¤ */
  --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
  --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",ui-sans-serif,system-ui;
  background: radial-gradient(800px 600px at 10% -10%, rgba(255,255,255,.06), transparent), var(--bg);
  color:var(--fg);
}
a{color:inherit;text-decoration:none}
.wrap{max-width:980px;margin:28px auto 64px;padding:0 14px}

/* â€¦ï¼ˆä»¥ä¸‹ CSS å…¨éƒ¨ä¿ç•™ï¼‰â€¦ */

/* ================== ğŸ”³ QR æƒææ‡¸æµ®è¦–çª—ï¼ˆæ–°å¢ï¼‰ ================== */
#scanBackdrop{display:none; align-items:center; justify-content:center;}
.scan-modal{
  width:min(760px,94vw); background:#0f1117; border-radius:16px; border:1px solid #2b3244;
  box-shadow:0 20px 60px rgba(0,0,0,.55); position:relative; padding:0; overflow:hidden;
}
.scan-head{
  position:sticky; top:0; z-index:2; display:flex; align-items:center; gap:10px;
  padding:10px 12px; background:#0f1117; border-bottom:1px solid #2b3244;
}
.scan-title{font-size:16px; font-weight:800}
.scan-close{
  margin-left:auto; width:28px; height:28px; background:transparent; border:none; color:#60a5fa;
  text-shadow:0 0 8px rgba(96,165,250,.8),0 0 14px rgba(96,165,250,.5); cursor:pointer; font-size:20px; line-height:1;
}
.scan-body{ position:relative; aspect-ratio:3/4; background:#000; }
#scanVideo{ width:100%; height:100%; object-fit:cover; display:block; }

/* å°æº–æ¡†èˆ‡åå­—ç·š */
.scan-overlay{
  position:absolute; inset:0; pointer-events:none;
  display:block;
}
.scan-frame{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(70vmin, 78%); aspect-ratio:1/1; /* æ­£æ–¹å½¢æ¡† */
  box-shadow:0 0 0 200vmax rgba(0,0,0,.35); /* å¤–æš—è§’ */
  border-radius:18px;
}
.scan-corners{
  position:absolute; inset:0;
}
.scan-corners::before,
.scan-corners::after{
  content:""; position:absolute; inset:0; border-radius:18px;
  border:2px solid transparent;
  /* ç”¨ç·šæ€§æ¼¸å±¤åªç•«å››è§’ */
  --g: #a7f3d0;
  background:
    linear-gradient(90deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) top/100% 2px,
    linear-gradient(90deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) bottom/100% 2px,
    linear-gradient(0deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) left/2px 100%,
    linear-gradient(0deg,var(--g) 0 10%,transparent 10% 90%,var(--g) 90% 100%) right/2px 100%;
  background-repeat:no-repeat;
  filter:drop-shadow(0 0 8px rgba(167,243,208,.45));
}
.scan-cross{
  position:absolute; inset:0;
}
.scan-cross::before, .scan-cross::after{
  content:""; position:absolute; left:50%; top:50%;
  background:#e5e7eb80; filter:drop-shadow(0 0 6px rgba(255,255,255,.35));
}
.scan-cross::before{ /* å‚ç›´ç·š */
  width:2px; height:52%; transform:translate(-50%,-50%);
}
.scan-cross::after{  /* æ°´å¹³ç·š */
  height:2px; width:52%; transform:translate(-50%,-50%);
}
.scan-hint{
  position:absolute; left:0; right:0; bottom:10px; text-align:center; font-size:12px; color:#cbd5e1;
  text-shadow:0 1px 2px rgba(0,0,0,.6);
}
.scan-foot{
  padding:8px 12px; border-top:1px solid #2b3244; display:flex; align-items:center; justify-content:flex-end; gap:8px; background:#0f1117;
}
.scan-btn{ padding:8px 10px; border-radius:10px; border:1px solid #2b3244; background:#0f1117; color:#e5e7eb; font-weight:800; cursor:pointer; }
.scan-btn.primary{ background:var(--btn-grad); color:#0b0c10; border:0; }

/* ============================================================ */
</style>
</head>
<body>
<div class="wrap">
  <!-- â€¦ï¼ˆåŸæœ¬ HTML çµæ§‹å®Œå…¨ä¿ç•™ï¼Œæœªæ›´å‹•ï¼‰â€¦ -->
  <!-- æ¨™é¡Œã€çµ±è¨ˆã€æ§åˆ¶é¢æ¿ã€å„ç¨® Modal ç­‰ -->
</div>

<!-- æ”¶åˆæ™‚é¡¯ç¤ºçš„å…­è‰²å½©è™¹é–‹é—œ -->
<button id="btnOvShow" class="ov-toggle" title="é¡¯ç¤ºç¸½è¦½ / Show Overview">
  <span class="dot" aria-hidden="true"></span><span>ç¸½è¦½ Overview</span>
</button>

<!-- ä»˜æ¬¾å½ˆçª—ã€æ¸…å–® Modalã€NOTE Modal â€¦ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ -->

<!-- ğŸ”³ æƒæ QR æ‡¸æµ®è¦–çª—ï¼ˆåŸæ¨£ä¿ç•™ï¼‰ -->
<div id="scanBackdrop" class="backdrop">
  <div class="scan-modal">
    <div class="scan-head">
      <div class="scan-title">æƒæ QR / Scan QR</div>
      <button id="scanClose" class="scan-close" aria-label="Close">Ã—</button>
    </div>
    <div class="scan-body">
      <video id="scanVideo" playsinline muted></video>
      <div class="scan-overlay">
        <div class="scan-frame">
          <div class="scan-corners"></div>
          <div class="scan-cross"></div>
          <div class="scan-hint">å°‡ QR å°æº–æ–¹æ¡†èˆ‡åå­—ç·šä¸­å¤®</div>
        </div>
      </div>
    </div>
    <div class="scan-foot">
      <button id="scanPickImage" class="scan-btn">å¾åœ–ç‰‡è¾¨è­˜</button>
      <button id="scanRetry" class="scan-btn">é‡æ–°é€£ç·š</button>
      <button id="scanDone" class="scan-btn primary">å®Œæˆ</button>
    </div>
  </div>
</div>

<!-- éš±è—çš„æª”æ¡ˆ input ä¾›ã€ŒQR åœ–ç‰‡å‚™æ´ã€ -->
<input id="qrFile" type="file" accept="image/*" capture="environment" style="display:none" />

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ===== (1) è¨­å®šï¼šæ›æˆä½ çš„ GAS URL ===== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwtoGYXhk6qd0XuTOUvB6YZNNzdjXoGQEl7298-Pbtc-G-qNuoLM2kTknZZOQO9qZ_Y1A/exec';
const PAY_PASSWORD = '05140714';
/* âœ… æ˜¯å¦å•Ÿç”¨é€å‡ºæ™‚å¯†ç¢¼é©—è­‰ï¼ˆæš«æ™‚é—œé–‰å°±è¨­ falseï¼›è¦å†é–‹å•Ÿæ”¹ trueï¼‰ */
const ENABLE_PAY_PASSWORD = false;
/* âœ… NOTE å¯†ç¢¼æ”¹ç‚ºç¨ç«‹å¸¸æ•¸ï¼ˆé è¨­ 0327ï¼‰ */
const NOTE_PASSWORD = '0327';

/* ===== (2) ç‹€æ…‹ ===== */
const state = {
  rows: [],          // é›²ç«¯ roster
  indexByItem: new Map(),
  selected: null,    // ä»˜æ¬¾å½ˆçª—é¸ä¸­çš„äºº
  chosenPay: null,   // 'paid' / 'unpaid'
  ovHidden: false,   // æ¦‚è¦½æ˜¯å¦æ”¶åˆ
  /* NOTE åŠŸèƒ½ï¼ˆé è¨­æ¬„å¯¬ï¼‰ */
  nameW: 60,
  igW: 60,
  /* æ¸…å–®ï¼ˆPaid/Unpaidï¼‰æ¬„å¯¬ï¼ˆæ»‘æ¡¿ä¸‰é …ï¼‰ */
  listNameW: 120,
  listIgW: 120,
  listLeaderW: 90,
  noteAuthed: false
};
const hiddenLeaders = new Set();
const RAINBOW = ['#EF4444','#F59E0B','#FACC15','#22C55E','#3B82F6','#8B5CF6'];

/* ===== (3) å°å·¥å…· ===== */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||'').toString().trim().toLowerCase();
const showToast = (msg)=>{
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1600);
};
const headMsg = (html, spinning=false)=>{
  $('head').innerHTML = '';
  const span = document.createElement('span');
  span.id='headMsg'; span.innerHTML = html;
  $('head').appendChild(span);
  if(spinning){
    const sp=document.createElement('span'); sp.className='spinner';
    $('head').appendChild(sp);
  }
};
/* å°åœ–ç¤ºï¼ˆå‹¾/å‰ï¼‰ */
const SVG_CHECK = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#22c55e" stroke-width="2.6"/><path d="M7 12.5l3 3 6-6" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';
const SVG_CROSS = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10.5" fill="#0f1117" stroke="#ef4444" stroke-width="2.6"/><path d="M8 8l8 8M16 8l-8 8" stroke="#fff" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span>';

/* ===== (4) è®€å–é›²ç«¯ï¼ˆé€²é å°±è¼‰ & æ¸²æŸ“ç¸½è¦½ï¼‰ ===== */
async function fetchRoster(){
  try{
    headMsg('è³‡æ–™è¼‰å…¥ä¸­â€¦ / Loading rosterâ€¦', true);
    const res = await fetch(WEB_APP_URL + '?mode=roster', {cache:'no-store'});
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.rows || []);
    rows.forEach(r=>{
      if(!('pay_status' in r) || !r.pay_status) r.pay_status = 'unpaid';
      // ç¢ºä¿ NOTE æ¬„ä½å­˜åœ¨ï¼ˆä¸ç ´å£æ—¢æœ‰ï¼‰
      if(!('confirm' in r)) r.confirm = false;
      if(!('pay_method' in r)) r.pay_method = '';
      if(!('note' in r)) r.note = '';
    });
    state.rows = rows;
    state.indexByItem.clear();
    for(const r of rows){ if(r.item) state.indexByItem.set(String(r.item), r); }

    rebuildDatalists();
    renderStats();
    headMsg('', false);
    renderOverview();
  }catch(err){
    console.error(err);
    headMsg('åå–®è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½ä¸æ˜¯ JSON æˆ– CORSï¼‰/ Failed to load roster', false);
  }
}
function rebuildDatalists(){
  const dlN = $('nameList'); const dlI = $('igList');
  dlN.innerHTML=''; dlI.innerHTML='';
  const names = [...new Set(state.rows.map(r=>r.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const igs = [...new Set(state.rows.map(r=>r.ig).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  names.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlN.appendChild(o); });
  igs.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlI.appendChild(o); });
}

/* ===== (5) çµ±è¨ˆ ===== */
function renderStats(){
  const total = state.rows.length;
  const paid = state.rows.filter(r=> norm(r.pay_status)==='paid').length;
  const unpaid = total - paid;
  $('sTotal').textContent = total;
  $('sPaid').textContent = paid;
  $('sUnpaid').textContent= unpaid;
}

/* ===== (6) æœå°‹ï¼ˆæ‰‹å‹•ï¼‰â†’ ä»˜æ¬¾å½ˆçª— ===== */
$('btnSearch').addEventListener('click', manualSearch);
$('nameInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });
$('igInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manualSearch(); });

function manualSearch(){
  if(!state.rows.length){ showToast('åå–®æœªå°±ç·’ / Roster not ready'); return; }
  const qn = norm($('nameInput').value);
  const qi = norm($('igInput').value);

  if(qi){
    const row = state.rows.find(r=> norm(r.ig)===qi);
    if(row) { openPayModal(row); return; }
  }
  if(qn){
    const row = state.rows.find(r=> norm(r.name)===qn);
    if(row) { openPayModal(row); return; }
  }
  const cand = state.rows.filter(r => (qi && norm(r.ig||'').includes(qi)) || (qn && norm(r.name||'').includes(qn)) );
  if(cand.length===1){ openPayModal(cand[0]); return; }
  renderOnlyMatches(cand);
}

function renderOnlyMatches(rows){
  const grid = $('grid'); grid.innerHTML = '';
  if(!rows || !rows.length){ headMsg('æŸ¥ç„¡è³‡æ–™ / No results', false); return; }
  headMsg(`ç¬¦åˆ ${rows.length} ç­† / matched records`, false);
  rows.slice().sort((a,b)=> (a.country||'').localeCompare(b.country||'') || (a.name||'').localeCompare(b.name||''))
    .forEach(r=> grid.appendChild(renderPerson(r)));
}

function renderPerson(r){
  const card = document.createElement('div');
  card.className='person';
  card.dataset.item = String(r.item||''); // â˜… åŠ å…¥ data-item ä¾›è£œä¸æ›´æ–°
  card.addEventListener('click', ()=> openPayModal(r)); // é»å¡ç‰‡é–‹å½ˆçª—

  // ç¬¬ä¸€è¡Œ
  const L1 = document.createElement('div'); L1.className='line';
  const left1 = document.createElement('div'); left1.className='left namebar';
  const flag = document.createElement('div'); flag.className='flag'; flag.textContent = r.flag || 'â€”';
  const ctry = document.createElement('span'); ctry.className='country'; ctry.textContent = r.country || 'â€”';
  const name = document.createElement('span'); name.className='personN goldtext'; name.textContent = r.name || 'â€”';
  const ig = document.createElement('span'); ig.className='ig goldtext'; ig.textContent = r.ig || 'â€”';
  left1.append(flag, ctry, name, ig);
  L1.append(left1);

  // ç¬¬äºŒè¡Œï¼špay_status + link
  const L2 = document.createElement('div'); L2.className='line';
  const left2 = document.createElement('div'); left2.className='left paybox iconsonly';
  left2.append(buildPay(r.pay_status, true));
  const right2 = document.createElement('div'); right2.className='right';
  if(r.link){
    const a = document.createElement('a'); a.href = r.link; a.target='_blank'; a.rel='noopener noreferrer'; a.className='link-btn';
    const img = document.createElement('img'); img.src='pngsucai_1605688_ec16ce.png'; img.alt='Open link';
    a.appendChild(img); right2.appendChild(a);
  }
  L2.append(left2, right2);

  card.append(L1,L2);
  return card;
}

function buildPay(status, iconsOnly=false){
  const s = norm(status)==='paid' ? 'paid' : 'unpaid';
  const box = document.createElement('div'); box.className='pay';
  const badge = document.createElement('div'); badge.className='badge '+s;
  badge.innerHTML = s==='paid'
    ? '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M7 12.5l3 3 6-6"/></svg>'
    : '<svg viewBox="0 0 24 24"><circle class="ring" cx="12" cy="12" r="10.5"/><path class="glyph" d="M8 8l8 8M16 8l-8 8"/></svg>';
  const circle = badge.querySelector('circle');
  if(circle){
    if(s==='paid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--ok')||'#22c55e');
    if(s==='unpaid') circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--bad')||'#ef4444');
  }
  box.append(badge);
  if(!iconsOnly){
    const lab = document.createElement('div'); lab.className='label';
    lab.innerHTML = s==='paid' ? '<span class="zh">å·²ç¹³è²»</span><span class="en">Paid</span>' : '<span class="zh">æœªç¹³è²»</span><span class="en">Unpaid</span>';
    box.append(lab);
  }
  return box;
}

/* ===== (7) ä»˜æ¬¾å½ˆçª— ===== */
const payBackdrop = $('payBackdrop');
const paySubmit = $('paySubmit');
$('payClose').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); });
$('payCloseX').addEventListener('click', ()=> { payBackdrop.style.display='none'; state.chosenPay=null; setOptActive(null); }); /* å³ä¸Šè§’å‰å‰ */
$('optPaid').addEventListener('click', ()=> setOptActive('paid'));
$('optUnpaid').addEventListener('click', ()=> setOptActive('unpaid'));

function setOptActive(val){
  state.chosenPay = val;
  document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
  if(val==='paid') $('optPaid').classList.add('active');
  if(val==='unpaid') $('optUnpaid').classList.add('active');
}

function openPayModal(person){
  state.selected = person;
  setOptActive(null);
  const gold = (s)=> `<b class="goldtext">${escapeHtml(s||'â€”')}</b>`;
  const html = `
    <div>åœ‹æ—— / Flagï¼š<b>${escapeHtml(person.flag||'â€”')}</b></div>
    <div>å§“å / Nameï¼š${gold(person.name)}</div>
    <div>IGï¼š${gold(person.ig)}</div>
    <div>ç›®å‰ç‹€æ…‹ / Currentï¼š<b>${norm(person.pay_status)==='paid'?'å·²ç¹³è²» / Paid':'æœªç¹³è²» / Unpaid'}</b></div>
  `;
  $('payInfo').innerHTML = html;
  payBackdrop.style.display='flex';
}
function escapeHtml(s){
  return (s||'').toString().replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

/* ===== é€å‡ºä»˜æ¬¾æ›´æ–° ===== */
paySubmit.addEventListener('click', async ()=>{
  if(!state.selected){ payBackdrop.style.display='none'; return; }
  if(!state.chosenPay){ showToast('è«‹é¸æ“‡ã€Œå·²ä»˜æ¬¾æˆ–æœªä»˜æ¬¾ã€'); return; }
  if (ENABLE_PAY_PASSWORD) {
    const p = prompt('è«‹è¼¸å…¥ä»˜æ¬¾æ›´æ–°å¯†ç¢¼ / Enter password');
    if(p === null) return;
    if(p !== PAY_PASSWORD){ showToast('å¯†ç¢¼éŒ¯èª¤ / Wrong password'); return; }
  }
  const prevHtml = paySubmit.innerHTML;
  paySubmit.disabled = true;
  paySubmit.innerHTML = 'é€å‡ºä¸­â€¦ <span class="spinner" aria-hidden="true"></span>';
  try{
    await updatePay(state.chosenPay);
  }catch(e){
    console.error(e);
    showToast('æ›´æ–°å¤±æ•— / Update failed');
  }finally{
    paySubmit.disabled = false;
    paySubmit.innerHTML = prevHtml;
    state.chosenPay = null; setOptActive(null);
    payBackdrop.style.display = 'none';
  }
});

/* â˜…â˜…â˜…â˜…â˜… åªè£œä¸æ›´æ–°ï¼Œä¸é‡ç¹ªæ•´é ï¼ˆå¤§å¹…é™ä½å»¶é²ï¼‰ â˜…â˜…â˜…â˜…â˜… */
function patchPayDom(item, val){
  const safe = String(item||'');
  document.querySelectorAll(`.person[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    const iconsOnly = el.classList.contains('iconsonly');
    el.innerHTML = ''; el.appendChild(buildPay(val, iconsOnly));
  });
  document.querySelectorAll(`.member-line[data-item="${CSS.escape(safe)}"] .paybox`).forEach(el=>{
    el.innerHTML = ''; el.appendChild(buildPay(val, /*iconsOnly*/ false));
  });
}

async function updatePay(val){
  const person = state.selected;
  try{
    const payload = { action:'updatePayStatus', item:String(person.item||''), pay_status:val };
    const ok = await postMaybeOk(payload);
    if(!ok) throw new Error('SERVER_NOK');
    person.pay_status = val;
    const local = state.indexByItem.get(String(person.item||'')); if(local) local.pay_status = val;
    renderStats(); patchPayDom(person.item, val);
    showToast('å·²æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ / Payment updated');
  }catch(e){
    console.error(e); showToast('æ›´æ–°å¤±æ•— / Update failed');
  }
}

/* èƒ½å®¹å¿å¤šç¨®å¾Œç«¯ Content-Type / CORS ç­–ç•¥ */
async function postMaybeOk(bodyObj){
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(bodyObj), mode:'cors', cache:'no-store' })) return true;
  const form = new URLSearchParams(); Object.entries(bodyObj).forEach(([k,v])=> form.append(k,String(v)));
  if(await tryFetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString(), mode:'no-cors', cache:'no-store' })) return true;
  return false;
}
async function tryFetch(url, init){
  try{
    const res = await fetch(url, init);
    if(res.type==='opaque') return true;
    if(res.ok) return true;
    try{ const j = await res.json(); return !!(j && (j.ok || Array.isArray(j))); }catch(_){}
    return false;
  }catch(_){ return false; }
}

/* ===== (8) æ¦‚è¦½ ===== */
/* â€¦ï¼ˆåŸæ¨£ä¿ç•™ï¼‰â€¦ */

/* ===== (9) æƒæ QRï¼ˆæ‡¸æµ®è¦–çª—ï¼‰ ===== */
$('btnScan').addEventListener('click', startScan);

const scan = {
  stream: null,
  detector: null,
  raf: 0,
  running: false,
  useJsQR: false
};

/* -------------------- jsQR å¾Œå‚™ï¼šlazy-load èˆ‡æŠ½å¹€è§£æ -------------------- */
let _offscreenCanvas = null, _offCtx = null, _lastJsQR = 0;
function getOffCanvas(w, h){
  if(!_offscreenCanvas){
    _offscreenCanvas = document.createElement('canvas');
    _offCtx = _offscreenCanvas.getContext('2d', { willReadFrequently: true });
  }
  _offscreenCanvas.width = w;
  _offscreenCanvas.height = h;
  return _offCtx;
}
function now(){ return performance && performance.now ? performance.now() : Date.now(); }

async function ensureJsQR(){
  if (window.jsQR) return true;
  return await new Promise((resolve)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
    s.async = true;
    s.onload = ()=> resolve(true);
    s.onerror = ()=> resolve(false);
    document.head.appendChild(s);
  });
}

async function loopDetectJsQR(){
  const video = $('scanVideo');
  const tick = ()=>{
    if(!scan.running || !scan.useJsQR) return;
    const t = now();
    // ä»¥ 120~150ms è§£æç¯€æµï¼Œé¿å…é«˜ CPU
    if (t - _lastJsQR < 140) { scan.raf = requestAnimationFrame(tick); return; }
    _lastJsQR = t;

    try{
      const vw = video.videoWidth || 0, vh = video.videoHeight || 0;
      if(vw && vh){
        // ç¸®åœ–åˆ°æœ€é•·é‚Š 640ï¼ˆæé€Ÿï¼‰ï¼Œç¶­æŒæ¯”ä¾‹
        const scale = Math.min(1, 640 / Math.max(vw, vh));
        const w = Math.max(160, Math.round(vw * scale));
        const h = Math.max(160, Math.round(vh * scale));
        const ctx = getOffCanvas(w, h);
        ctx.drawImage(video, 0, 0, w, h);
        const img = ctx.getImageData(0, 0, w, h);
        if (window.jsQR){
          const res = window.jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
          if (res && res.data){
            const raw = (res.data||'').trim();
            closeScanModal().then(()=> handleScanItem(raw));
            return;
          }
        }
      }
    }catch(err){ console.warn('jsQR detect err', err); }
    scan.raf = requestAnimationFrame(tick);
  };
  scan.raf = requestAnimationFrame(tick);
}
/* -------------------- jsQR å¾Œå‚™çµæŸ -------------------- */

async function startScan(){
  openScanModal();

  // â‘  å…ˆè«‹æ±‚ç›¸æ©Ÿï¼ˆç¢ºä¿ iPhone æœƒè·³æ¬Šé™ï¼‰
  try{
    scan.stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'environment' },
      audio:false
    });
  }catch(e){
    console.warn('getUserMedia å¤±æ•—', e);
    if (e && (e.name === 'NotAllowedError' || e.name === 'SecurityError')) {
      showToast('ç„¡æ³•ä½¿ç”¨ç›¸æ©Ÿï¼Œè«‹åœ¨ Safari çš„ç¶²ç«™è¨­å®šå…è¨±ç›¸æ©Ÿ');
    } else if (e && e.name === 'NotFoundError') {
      showToast('æœªåµæ¸¬åˆ°ç›¸æ©Ÿè£ç½®');
    } else {
      showToast('ç›¸æ©Ÿå•Ÿç”¨å¤±æ•—ï¼Œæ”¹ç”¨åœ–ç‰‡è¾¨è­˜');
    }
    pickImageForScan(); // é€€å›åœ–ç‰‡è¾¨è­˜
    return;
  }

  // é¡¯ç¤ºç›¸æ©Ÿç•«é¢
  const video = $('scanVideo');
  video.srcObject = scan.stream;
  await video.play();

  // â‘¡ å„ªå…ˆä½¿ç”¨ BarcodeDetectorï¼›è‹¥ä¸æ”¯æ´ â†’ å¾Œå‚™ jsQR
  if (!('BarcodeDetector' in window)) {
    scan.useJsQR = await ensureJsQR();
    if (!scan.useJsQR){
      showToast('æ­¤è£ç½®ä¸æ”¯æ´å³æ™‚è§£æï¼›è«‹æ”¹ç”¨åœ–ç‰‡è¾¨è­˜æˆ–æ‰‹å‹•æŸ¥æ‰¾');
      return;
    }
    showToast('å·²å•Ÿç”¨ jsQR å¾Œå‚™è§£æ');
    scan.running = true;
    loopDetectJsQR();
    return;
  }
  try{
    scan.detector = new window.BarcodeDetector({ formats:['qr_code'] });
  }catch(e){
    console.warn('BarcodeDetector å»ºç«‹å¤±æ•—', e);
    scan.useJsQR = await ensureJsQR();
    if (!scan.useJsQR){
      showToast('è£ç½®ä¸æ”¯æ´å³æ™‚è§£æï¼›è«‹æ”¹ç”¨åœ–ç‰‡è¾¨è­˜æˆ–æ‰‹å‹•æŸ¥æ‰¾');
      return;
    }
    showToast('å·²å•Ÿç”¨ jsQR å¾Œå‚™è§£æ');
    scan.running = true;
    loopDetectJsQR();
    return;
  }

  // â‘¢ é€²å…¥å³æ™‚æƒæï¼ˆåŸç”Ÿæ¢ç¢¼ï¼‰
  scan.useJsQR = false;
  scan.running = true;
  loopDetectNative();
}

async function loopDetectNative(){
  const video = $('scanVideo');
  const tick = async ()=>{
    if(!scan.running || !scan.detector) return;
    try{
      if(video.readyState >= 2){
        const bitmap = await createImageBitmap(video);
        const codes = await scan.detector.detect(bitmap);
        bitmap.close();
        if(codes && codes.length){
          const raw = (codes[0].rawValue||'').trim();
          await closeScanModal();
          handleScanItem(raw);
          return;
        }
      }
    }catch(err){
      console.warn('native detect err', err);
      // ä¸€æ—¦åŸç”Ÿåµæ¸¬å ±éŒ¯ï¼Œç«‹å³åˆ‡æ›åˆ° jsQR å¾Œå‚™ï¼ˆé¿å…å¡ä½ï¼‰
      scan.useJsQR = await ensureJsQR();
      if (scan.useJsQR){
        showToast('å·²åˆ‡æ›åˆ° jsQR å¾Œå‚™è§£æ');
        loopDetectJsQR();
        return;
      }
    }
    scan.raf = requestAnimationFrame(tick);
  };
  scan.raf = requestAnimationFrame(tick);
}

async function stopScan(){
  scan.running = false;
  if(scan.raf){ cancelAnimationFrame(scan.raf); scan.raf = 0; }
  try{
    if(scan.stream){ scan.stream.getTracks().forEach(t=>t.stop()); }
  }catch(_){}
  scan.stream = null;
}

function openScanModal(){
  $('scanBackdrop').style.display='flex';
}
async function closeScanModal(){
  await stopScan();
  $('scanBackdrop').style.display='none';
}

/* æ‡¸æµ®è¦–çª—æŒ‰éˆ• */
$('scanClose').addEventListener('click', closeScanModal);
$('scanDone').addEventListener('click', closeScanModal);
$('scanRetry').addEventListener('click', async ()=>{
  await stopScan();
  startScan();
});
$('scanPickImage').addEventListener('click', pickImageForScan);

function pickImageForScan(){
  const input = $('qrFile');
  input.onchange = async (e)=>{
    const f = (e.target.files||[])[0];
    if(!f){ showToast('æœªé¸å–åœ–ç‰‡'); return; }
    try{
      // å…ˆå˜—è©¦ BarcodeDetector
      if('BarcodeDetector' in window){
        try{
          const detector = new window.BarcodeDetector({ formats:['qr_code'] });
          const bmp = await createImageBitmap(f);
          const codes = await detector.detect(bmp);
          bmp.close();
          if(codes && codes.length){
            const raw = (codes[0].rawValue||'').trim();
            await closeScanModal();
            handleScanItem(raw);
            return;
          }
        }catch(e){ /* ç¹¼çºŒèµ° jsQR å¾Œå‚™ */ }
      }
      // å¾Œå‚™ï¼šjsQR
      const ok = await ensureJsQR();
      if (!ok){ throw new Error('jsQR-load-failed'); }

      const imgBitmap = await createImageBitmap(f);
      const w = Math.min(1280, imgBitmap.width);
      const h = Math.round(imgBitmap.height * (w / imgBitmap.width));
      const ctx = getOffCanvas(w, h);
      ctx.drawImage(imgBitmap, 0, 0, w, h);
      imgBitmap.close();

      const img = ctx.getImageData(0, 0, w, h);
      const res = window.jsQR && window.jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
      if(res && res.data){
        const raw = (res.data||'').trim();
        await closeScanModal();
        handleScanItem(raw);
      }else{
        showToast('è§£æå¤±æ•—ï¼Œè«‹æ›å¼µæ¸…æ¥šçš„ QR åœ–ç‰‡');
      }
    }catch(err){
      console.warn(err); showToast('è£ç½®ä¸æ”¯æ´ QR è§£æï¼›è«‹æ”¹ç”¨æ‰‹å‹•æŸ¥æ‰¾');
    } finally { input.value=''; }
  };
  input.click();
}

function handleScanItem(itemStr){
  if(!itemStr){ showToast('QR ç„¡å…§å®¹ / Empty QR'); return; }
  const row = state.indexByItem.get(String(itemStr));
  if(!row){ showToast('æŸ¥ç„¡æ­¤ ITEM Â· è«‹ç¢ºèª / Item not found'); return; }
  openPayModal(row);
}

/* ===== (10) é‡æ–°æ•´ç† & æ•…éšœè¨ºæ–· ===== */
$('btnRefresh').addEventListener('click', ()=> fetchRoster()); // è¨ºæ–·æŒ‰éˆ•æš«ä¸é‹ä½œï¼ˆå·²æ–¼ HTML éš±è—ä¸¦ disabledï¼‰

/* ===== (11) å·²ç¹³è²»/æœªç¹³è²»æ¸…å–® ===== */
/* â€¦ï¼ˆåŸæ¨£ä¿ç•™ï¼‰â€¦ */

/* ===== (12) NOTE åŠŸèƒ½ ===== */
/* â€¦ï¼ˆåŸæ¨£ä¿ç•™ï¼‰â€¦ */

/* ===== å•Ÿå‹• & éŒ¯èª¤æ””æˆª ===== */
window.addEventListener('error', (e)=>{ try{ console.error('[GlobalError]', e.message, e.filename, e.lineno, e.colno, e.error); }catch(_){}
  try{ showToast('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (e.message || 'Script error')); }catch(_){} });
window.addEventListener('unhandledrejection', (e)=>{ try{ console.error('[UnhandledRejection]', e.reason); }catch(_){}
  try{ showToast('ç™¼ç”ŸéŒ¯èª¤ï¼ˆPromiseï¼‰ï¼š' + (e.reason && e.reason.message ? e.reason.message : '')); }catch(_){}

});

/* ===== List/Note èƒŒæ™¯é»æ“Šæ”¶åˆ ===== */
listBackdrop.addEventListener('click', (e)=>{ if(e.target===listBackdrop) listBackdrop.style.display='none'; });

fetchRoster();
</script>
</body>
</html>
